<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#000000">
<meta name="description" content="Save your parking spot and navigate back to it">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Mark Park">
<link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23000' width='100' height='100'/><text y='75' x='50' text-anchor='middle' font-size='70'>üÖøÔ∏è</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%23000' width='180' height='180' rx='40'/><text y='130' x='90' text-anchor='middle' font-size='100'>üÖøÔ∏è</text></svg>">
<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1hcmsgUGFyayAtIFBhcmtpbmcgRmluZGVyIiwKICAic2hvcnRfbmFtZSI6ICJNYXJrIFBhcmsiLAogICJkZXNjcmlwdGlvbiI6ICJTYXZlIHlvdXIgcGFya2luZyBzcG90IGFuZCBuYXZpZ2F0ZSBiYWNrIHRvIGl0IiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMwMDAwMDAiLAogICJ0aGVtZV9jb2xvciI6ICIjMDAwMDAwIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsPHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxOTIgMTkyJz48cmVjdCBmaWxsPSclMjMwMDAnIHdpZHRoPScxOTInIGhlaWdodD0nMTkyJyByeD0nNDAnLz48dGV4dCB5PScxNDAnIHg9Jzk2JyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmb250LXNpemU9JzEyMCc+8J+FvvC3iDwvdGV4dD48L3N2Zz4iLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbCw8c3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDUxMiA1MTInPjxyZWN0IGZpbGw9JyUyMzAwMCcgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInIHJ4PSc5MCcvPjx0ZXh0IHk9JzM4MCcgeD0nMjU2JyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmb250LXNpemU9JzMyMCc+8J+FvvC3iDwvdGV4dD48L3N2Zz4iLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiLAogICAgICAicHVycG9zZSI6ICJhbnkgbWFza2FibGUiCiAgICB9CiAgXQp9">
<title>Mark Park</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
* {margin:0;padding:0;box-sizing:border-box;}
body {
    font-family:'Inter',sans-serif;
    background:#000; 
    color:white;
    overflow-x:hidden;
}

.container{position:relative;max-width:1400px;margin:0 auto;padding:1rem;}
header{text-align:center;margin-bottom:1.5rem;}
h1{font-size:clamp(2rem,5vw,3.5rem);font-weight:800;color:white;}
.subtitle{color:rgba(255,255,255,.6);}

.main-grid{display:grid;grid-template-columns:1fr;gap:1.5rem;}
@media(min-width:1024px){.main-grid{grid-template-columns:2fr 1fr;}}

.map-section{
    position:relative;
    height:70vh;
    background:#111;
    border:1px solid rgba(255,255,255,.2);
    border-radius:1rem;
    overflow:hidden;
    touch-action: pan-y pinch-zoom;
}
#map{
    width:100%;
    height:100%;
    touch-action: none;
}

@media(max-width:1023px){
    .map-section{
        height:50vh;
        min-height:400px;
    }
}

.center-btn {
    position:absolute;
    bottom:1rem;
    left:1rem;
    z-index:1500;
    width:50px;height:50px;
    border-radius:50%;
    background:rgba(59,130,246,.9);
    border:none;color:white;
    display:flex;align-items:center;justify-content:center;
    font-size:1.3rem;
    cursor:pointer;
    box-shadow:0 4px 12px rgba(0,0,0,.3);
    transition:all 0.3s;
}
.center-btn:hover{transform:scale(1.1);}
.center-btn:active{transform:scale(0.95);}

.distance-box{
    position:absolute;
    bottom:1rem;
    right:1rem;
    background:rgba(0,0,0,.8);
    padding:.8rem 1.2rem;
    border-radius:.75rem;
    font-size:1.1rem;
    font-weight:600;
    border:1px solid rgba(255,255,255,.2);
    z-index:1500;
    display:none;
    box-shadow:0 4px 12px rgba(0,0,0,.3);
}

.map-controls{
    position:absolute;top:.75rem;right:.75rem;z-index:1000;
    display:flex;flex-direction:column;gap:.5rem;
}
.btn{
    padding:.7rem 1.1rem;
    border:none;border-radius:.75rem;
    font-weight:600;font-size:.9rem;
    cursor:pointer;
    backdrop-filter:blur(10px);
    box-shadow:0 4px 12px rgba(0,0,0,.3);
    transition:transform 0.2s, opacity 0.2s;
}
.btn:hover{transform:translateY(-2px);}
.btn:active{transform:translateY(0);}
.btn-locate{background:rgba(59,130,246,.95);color:white;}
.btn-save{background:rgba(34,197,94,.95);color:white;}
.btn-navigate{background:rgba(168,85,247,.95);color:white;display:none;}
.btn-clear{background:rgba(239,68,68,.95);color:white;display:none;}

.card{
    background:#111;
    border:1px solid rgba(255,255,255,.1);
    padding:1.5rem;border-radius:1rem;
}
.card h2{margin-bottom:1rem;font-size:1.3rem;}
#location-details p{margin:0.5rem 0;line-height:1.6;}

#navigation-panel{
    margin-top:1rem;
    background:#111;
    border:1px solid rgba(255,255,255,.15);
    padding:1.5rem;
    border-radius:1rem;
    display:none;
}
#navigation-panel h3{
    margin-bottom:1rem;
    color:white;
    font-size:1.2rem;
}
#navigation-steps{
    color:#ccc;
    line-height:1.8;
}

.modal{
    display:none;
    position:fixed;
    z-index:2000;
    left:0;top:0;
    width:100%;height:100%;
    background:rgba(0,0,0,.8);
    backdrop-filter:blur(5px);
}
.modal-content{
    background:#1a1a1a;
    margin:15% auto;
    padding:2rem;
    border:1px solid rgba(255,255,255,.2);
    border-radius:1rem;
    width:90%;
    max-width:500px;
    box-shadow:0 10px 40px rgba(0,0,0,.5);
}
.modal-content h3{
    margin-bottom:1rem;
    color:white;
}
.modal-content textarea{
    width:100%;
    padding:.8rem;
    border:1px solid rgba(255,255,255,.3);
    border-radius:.5rem;
    background:#111;
    color:white;
    font-size:1rem;
    min-height:80px;
    margin-bottom:1rem;
    font-family:'Inter',sans-serif;
}
.modal-buttons{
    display:flex;
    gap:.5rem;
    justify-content:flex-end;
}
.modal-btn{
    padding:.7rem 1.5rem;
    border:none;
    border-radius:.5rem;
    cursor:pointer;
    font-weight:600;
    font-size:.9rem;
}
.modal-btn-save{background:#22c55e;color:white;}
.modal-btn-cancel{background:#374151;color:white;}

footer{text-align:center;color:rgba(255,255,255,.4);margin:1.5rem 0;font-size:.9rem;}
</style>
</head>

<body>

<div class="container">
<header>
<h1>Mark Park</h1>
<p class="subtitle">Save your parking spot and navigate back to it</p>
</header>

<div class="main-grid">

<div>
<div class="map-section">
    <div id="map"></div>

    <button id="center-location-btn" class="center-btn" title="Center on my location">üìç</button>

    <div id="distance-box" class="distance-box">0 m</div>

    <div class="map-controls">
        <button id="locate-btn" class="btn btn-locate" title="Find my location">üìç Find</button>
        <button id="save-btn" class="btn btn-save" title="Save parking location">üíæ Save</button>
        <button id="navigate-btn" class="btn btn-navigate" title="Navigate to parking">üß≠ Navigate</button>
        <button id="clear-btn" class="btn btn-clear" title="Clear saved location">üóëÔ∏è Clear</button>
    </div>
</div>

<div id="navigation-panel">
    <h3>üìç Turn-by-Turn Directions</h3>
    <div id="navigation-steps">No navigation data</div>
</div>
</div>

<div class="info-panel">
<div class="card">
<h2>üìç Saved Location</h2>
<div id="location-details">
<p style="opacity:.5;">üÖøÔ∏è No parking location saved yet</p>
</div>
</div>
</div>

</div>

<footer>By AKSHATH | Mark Park v2.0</footer>
</div>

<div id="descriptionModal" class="modal">
    <div class="modal-content">
        <h3>üíæ Save Parking Location</h3>
        <p style="opacity:.7;margin-bottom:1rem;">Add details about your parking spot (optional)</p>
        <textarea id="parkingDescription" placeholder="e.g., Floor 3, Near elevator, Bay A12, Red zone..."></textarea>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="closeModal()">Cancel</button>
            <button class="modal-btn modal-btn-save" onclick="confirmSave()">Save Location</button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
let map, userMarker, parkingMarker, routingControl;
let userWatchId = null;
let savedLocation = null;
let autoFollow = false;

const navigationPanel = document.getElementById("navigation-panel");
const navigationSteps = document.getElementById("navigation-steps");
const distanceBox = document.getElementById("distance-box");
const modal = document.getElementById("descriptionModal");
const descriptionInput = document.getElementById("parkingDescription");

function initMap(){
    map = L.map('map', {
        zoomControl: true,
        touchZoom: true,
        scrollWheelZoom: false,
        dragging: true,
        tap: true,
        doubleClickZoom: true
    }).setView([12.9716, 77.5946], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    map.once('focus', function() { map.scrollWheelZoom.enable(); });
    map.on('click', function() { map.scrollWheelZoom.enable(); });
    map.on('mouseout', function() { map.scrollWheelZoom.disable(); });

    updateLocationDetails();
}

initMap();

function locateUser(){
    if(!navigator.geolocation){
        alert("Geolocation is not supported by your browser");
        return;
    }
    
    if(userWatchId !== null){
        navigator.geolocation.clearWatch(userWatchId);
    }
    
    userWatchId = navigator.geolocation.watchPosition(
        pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            if(!userMarker){
                userMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-marker',
                        html: '<div style="background:#3b82f6;width:18px;height:18px;border-radius:50%;border:4px solid white;box-shadow:0 0 15px rgba(59,130,246,0.7);"></div>',
                        iconSize: [26, 26],
                        iconAnchor: [13, 13]
                    })
                }).addTo(map);
                map.setView([lat, lng], 16);
            } else {
                userMarker.setLatLng([lat, lng]);
                if(autoFollow){
                    map.panTo([lat, lng]);
                }
            }

            updateDistance();
        },
        err => {
            console.error("Location error:", err);
            alert("Unable to get your location. Please enable location services.");
        },
        {
            enableHighAccuracy: true,
            maximumAge: 5000,
            timeout: 10000
        }
    );
}

function addMarker(loc){
    if(parkingMarker) map.removeLayer(parkingMarker);
    
    parkingMarker = L.marker([loc.lat, loc.lng], {
        icon: L.divIcon({
            className: 'parking-marker',
            html: '<div style="font-size:40px;text-shadow:2px 2px 4px rgba(0,0,0,0.5);">üÖøÔ∏è</div>',
            iconSize: [40, 40],
            iconAnchor: [20, 40]
        })
    }).addTo(map);
    
    let popupContent = `<b style="font-size:1.1rem;">üÖøÔ∏è Your Parking Spot</b><br>`;
    if(loc.description){
        popupContent += `<p style="margin-top:0.5rem;">${loc.description}</p>`;
    }
    popupContent += `<small style="opacity:0.7;">Saved: ${loc.timestamp}</small>`;
    
    parkingMarker.bindPopup(popupContent);
}

function showModal(){
    if(!userMarker){
        alert("Please enable location first by clicking 'Find'");
        return;
    }
    descriptionInput.value = "";
    modal.style.display = "block";
}

function closeModal(){
    modal.style.display = "none";
}

function confirmSave(){
    const pos = userMarker.getLatLng();
    const description = descriptionInput.value.trim();
    
    savedLocation = {
        lat: pos.lat,
        lng: pos.lng,
        timestamp: new Date().toLocaleString(),
        description: description
    };

    addMarker(savedLocation);
    updateLocationDetails();

    document.getElementById("navigate-btn").style.display = "flex";
    document.getElementById("clear-btn").style.display = "flex";
    distanceBox.style.display = "block";
    
    closeModal();
    
    setTimeout(() => {
        if(parkingMarker) parkingMarker.openPopup();
    }, 300);
}

function updateLocationDetails(){
    const panel = document.getElementById("location-details");
    if(savedLocation){
        panel.innerHTML = `
            <p><strong>üìÖ Saved:</strong> ${savedLocation.timestamp}</p>
            ${savedLocation.description ? `<p><strong>üìù Details:</strong> ${savedLocation.description}</p>` : ''}
            <p><strong>üìç Coordinates:</strong><br>${savedLocation.lat.toFixed(6)}, ${savedLocation.lng.toFixed(6)}</p>
        `;
    } else {
        panel.innerHTML = '<p style="opacity:.5;">üÖøÔ∏è No parking location saved yet</p>';
    }
}

function navigateToParking(){
    if(!savedLocation){
        alert("No parking location saved. Please save a location first.");
        return;
    }
    
    if(!userMarker){
        alert("Please enable location first by clicking 'Find'");
        return;
    }

    const userPos = userMarker.getLatLng();
    const parkingPos = L.latLng(savedLocation.lat, savedLocation.lng);

    // Remove existing route
    if(routingControl) map.removeControl(routingControl);

    // Show loading
    navigationPanel.style.display = "block";
    navigationSteps.innerHTML = '<div style="text-align:center;padding:2rem;">üîÑ Calculating route...</div>';

    // Create routing control with proper error handling
    routingControl = L.Routing.control({
        waypoints: [
            L.latLng(userPos.lat, userPos.lng),
            L.latLng(parkingPos.lat, parkingPos.lng)
        ],
        routeWhileDragging: false,
        addWaypoints: false,
        draggableWaypoints: false,
        fitSelectedRoutes: true,
        showAlternatives: false,
        lineOptions: {
            styles: [{color: "#a855f7", weight: 6, opacity: 0.8}]
        },
        createMarker: () => null,
        router: L.Routing.osrmv1({
            serviceUrl: 'https://router.project-osrm.org/route/v1',
            profile: 'car'
        }),
        formatter: new L.Routing.Formatter({
            units: 'metric'
        })
    })
    .on('routesfound', e => {
        try {
            const route = e.routes[0];
            const summary = route.summary;
            const instructions = route.instructions;

            const distKm = (summary.totalDistance / 1000).toFixed(2);
            const timeMin = Math.round(summary.totalTime / 60);

            let html = `
                <div style="background:#1a1a1a;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
                    <strong>üìè Distance:</strong> ${distKm} km<br>
                    <strong>‚è±Ô∏è Estimated Time:</strong> ${timeMin} min<br>
                    <strong>üöó Route Type:</strong> Driving
                </div>
            `;

            if(instructions && instructions.length > 0){
                instructions.forEach((step, i) => {
                    const icon = step.type === 'WaypointReached' ? 'üéØ' : '‚û°Ô∏è';
                    html += `<div style="margin:0.7rem 0;padding:0.5rem;background:#0a0a0a;border-radius:0.5rem;">
                                <strong>${icon} Step ${i + 1}:</strong> ${step.text}
                             </div>`;
                });
            }

            navigationSteps.innerHTML = html;
            navigationPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } catch(err) {
            console.error("Route display error:", err);
            showSimpleRoute();
        }
    })
    .on('routingerror', e => {
        console.error("Routing error:", e);
        showSimpleRoute();
    })
    .addTo(map);

    // Fallback: Show simple straight line if routing fails
    setTimeout(() => {
        if(navigationSteps.innerHTML.includes('Calculating')) {
            showSimpleRoute();
        }
    }, 5000);
}

// Fallback function for simple navigation
function showSimpleRoute(){
    if(!savedLocation || !userMarker) return;

    const userPos = userMarker.getLatLng();
    const parkingPos = L.latLng(savedLocation.lat, savedLocation.lng);
    const distance = userPos.distanceTo(parkingPos);

    // Draw simple line
    if(routingControl) map.removeControl(routingControl);
    
    const line = L.polyline([
        [userPos.lat, userPos.lng],
        [parkingPos.lat, parkingPos.lng]
    ], {
        color: '#a855f7',
        weight: 4,
        opacity: 0.7,
        dashArray: '10, 10'
    }).addTo(map);

    // Store for cleanup
    if(window.simpleLine) map.removeLayer(window.simpleLine);
    window.simpleLine = line;

    // Fit bounds
    map.fitBounds(line.getBounds(), {padding: [50, 50]});

    // Calculate bearing for direction
    const bearing = getBearing(userPos.lat, userPos.lng, parkingPos.lat, parkingPos.lng);
    const direction = getDirection(bearing);

    const distKm = (distance / 1000).toFixed(2);
    const distM = Math.round(distance);

    navigationPanel.style.display = "block";
    navigationSteps.innerHTML = `
        <div style="background:#1a1a1a;padding:1rem;border-radius:0.5rem;margin-bottom:1rem;">
            <strong>üìè Straight-line Distance:</strong> ${distance >= 1000 ? distKm + ' km' : distM + ' m'}<br>
            <strong>üß≠ Direction:</strong> ${direction}
        </div>
        <div style="margin:1rem 0;padding:1rem;background:#0a0a0a;border-radius:0.5rem;">
            <strong>üéØ Simple Navigation:</strong><br>
            Head ${direction} towards your parking spot.<br><br>
            <em style="opacity:0.7;">Tip: You can also use Google Maps or your phone's navigation app for turn-by-turn directions.</em>
        </div>
        <button onclick="openInGoogleMaps()" style="width:100%;padding:1rem;background:#4285f4;border:none;border-radius:0.5rem;color:white;font-weight:600;cursor:pointer;margin-top:1rem;">
            üó∫Ô∏è Open in Google Maps
        </button>
    `;
}

// Calculate bearing between two points
function getBearing(lat1, lon1, lat2, lon2) {
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const y = Math.sin(dLon) * Math.cos(lat2 * Math.PI / 180);
    const x = Math.cos(lat1 * Math.PI / 180) * Math.sin(lat2 * Math.PI / 180) -
              Math.sin(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.cos(dLon);
    let bearing = Math.atan2(y, x) * 180 / Math.PI;
    bearing = (bearing + 360) % 360;
    return bearing;
}

// Convert bearing to compass direction
function getDirection(bearing) {
    const directions = ['North', 'North-East', 'East', 'South-East', 'South', 'South-West', 'West', 'North-West'];
    const index = Math.round(bearing / 45) % 8;
    return directions[index];
}

// Open in Google Maps
function openInGoogleMaps() {
    if(!savedLocation || !userMarker) return;
    const userPos = userMarker.getLatLng();
    const url = `https://www.google.com/maps/dir/?api=1&origin=${userPos.lat},${userPos.lng}&destination=${savedLocation.lat},${savedLocation.lng}&travelmode=driving`;
    window.open(url, '_blank');
}

function updateDistance(){
    if(!savedLocation || !userMarker) return;
    
    const u = userMarker.getLatLng();
    const p = L.latLng(savedLocation.lat, savedLocation.lng);
    const d = u.distanceTo(p);
    
    if(d >= 1000){
        distanceBox.innerHTML = (d / 1000).toFixed(2) + " km";
    } else {
        distanceBox.innerHTML = Math.round(d) + " m";
    }
}

function clearLocation(){
    if(!confirm("Are you sure you want to clear the saved parking location?")){
        return;
    }
    
    savedLocation = null;

    if(parkingMarker) map.removeLayer(parkingMarker);
    if(routingControl) map.removeControl(routingControl);
    if(window.simpleLine) map.removeLayer(window.simpleLine);

    document.getElementById("navigate-btn").style.display = "none";
    document.getElementById("clear-btn").style.display = "none";

    distanceBox.style.display = "none";
    navigationPanel.style.display = "none";
    
    updateLocationDetails();
}

document.getElementById("center-location-btn").onclick = () => {
    if(!userMarker){
        alert("Please enable location first by clicking 'Find'");
        return;
    }
    
    autoFollow = !autoFollow;
    const btn = document.getElementById("center-location-btn");
    
    if(autoFollow){
        btn.style.background = "rgba(34,197,94,.9)";
        btn.title = "Auto-follow ON - Click to disable";
        map.setView(userMarker.getLatLng(), 17, {animate: true, duration: 0.5});
    } else {
        btn.style.background = "rgba(59,130,246,.9)";
        btn.title = "Auto-follow OFF - Click to enable";
    }
};

document.getElementById("locate-btn").onclick = locateUser;
document.getElementById("save-btn").onclick = showModal;
document.getElementById("navigate-btn").onclick = navigateToParking;
document.getElementById("clear-btn").onclick = clearLocation;

window.onclick = (event) => {
    if(event.target == modal){
        closeModal();
    }
};

setTimeout(() => {
    locateUser();
}, 500);
</script>

</body>
</html>